<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Number of Atoms</title>
</head>
<body>

  <script>
    let atoms = 'K4(ON(SO3)2)2';
    while (/\((\w*)\)(\d)/.test(atoms)) {
      const match = (atoms.match(/\((\w*)\)(\d*)/));
      let innerArr = match[1].split(/([A-Z][a-z]*)/g).slice(1);
      const multiplier = Number(match[2]);
      innerArr = innerArr.map(char => (char.length ? char : '1'));
      innerArr = innerArr.map(char => Number(char) ? (Number(char)) * multiplier : char);
      atoms = atoms.replace(match[0], innerArr.join(''));
    }
    atoms = atoms.split(/([A-Z][a-z]*\d*)/g).filter(char => char.length);
    atoms = atoms.sort().join('');
    atoms = atoms.split(/([A-Z][a-z]*)/g).slice(1);
    atoms = atoms.map(char => (char.length ? char : '1')).reduce(reducer, []);
    atoms = atoms.filter(char => char != '1').join('');
    console.log(atoms);

    function reducer(accumulator, currentValue, index, array) {
      if (!accumulator.includes(currentValue) && !Number(currentValue)) {
        accumulator.push(currentValue);
        if (Number(array[index + 1])) {
          accumulator.push(array[index + 1]);
        }
      } else if (accumulator.includes(currentValue) && !Number(currentValue)) {
        if (Number(array[index + 1])) {
          let accNum  = accumulator[accumulator.indexOf(currentValue) + 1]
          accumulator[accumulator.indexOf(currentValue) + 1] = Number(accNum) + Number(array[index + 1]);
        }
      }
      return accumulator;
    }
  </script>
</body>
</html>
